<html>
<head>
	<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true&key=AIzaSyBBXHUUOD1cSwsHzXcCxNLwkLLVX0PHB8I"></script>
	<!--<script type="text/javascript" src="http://code.jquery.com/jquery-1.11.3.min.js"></script>-->
	<script type="text/javascript" src="../js/jquery-1.11.2.min.js"></script>
	<script type="text/javascript" src="../js/jquery.ui.map.min.js"></script>
</head>
<body>
<!--<input type="button" id="ipt1" value="Get json" />
<input type="button" id="ipt2" value="Get latlng" />-->
   <script type="text/javascript">
   $(document).ready(function () {          
         //$('#ipt1').click(function () {		
              var JData = GetInfo();
			  var i = 0;
			//這裡改用.each這個函式來取出JData裡的物件
				$.each(JData, function() {
				
				$("#JSON_table").append("<tr class='tra'>" +
                          "<td><input class='idx' value='" + JData[i].post.id   + "' /></td>" +                
                          "<td class='adr'><input class='addrx' value='" + JData[i].post.officeadress + "' /></td>" +
                          "<td><input class='lat' /></td>" +					
						"</tr>");
				i++;
				});
            //});
		/* $('#ipt2').click(function () {
			setTimeout(addr2latlng, 1000);
		 });*/
		 var ct=0; //check 座標為0之連續次數		 
	    var addr2latlng= function(){
			var v=$(".tra:first");//第一個元素
			 	if (v.find('.lat').val()==""){
					parsePosition( v.find('.addrx').val(), v.find('.lat') ,v.find('.idx').val());//取座標
					//$("#msg").append(' > time-out:'+$.now());					
				v.remove();//上層元素
				var dt=1000;
				if (ct >= 1){ //連續n+1次,重新載入
				 dt=5000;
				 ct=0;
				 $("#msg").append("delay change to 5sec!!<br>");
				 location.reload();//重新載入
				}
				setTimeout(addr2latlng, dt);
				return false;
				}				
		}
			
            /*============ function================*/
			function SetInfo(lat,lng,idx) {
               var $res;
               $.ajax({
                   type: "get",
                   url: "gs_fire.php",
                   contentType: "application/json; charset=utf-8",				
				   async: false,
                   cache: false,
                   dataType: 'json',
			      data: "idx="+idx+"&lat="+lat+"&lng="+lng
				});
              return $res;
          }
		  
		  /*===================================*/
            function GetInfo() {
               var $res;
               $.ajax({
                   type: "get",
                   url: "ws_fire.php",
                   contentType: "application/json; charset=utf-8",
				   async: false,
                   cache: false,
                   dataType: 'json',
				  data: "format=json&num=500",
                  success: function (data) {
                      if (data.hasOwnProperty("posts")) 
						$res = data.posts;
                      else
                         $res = data;
                  }
              });
              return $res;
          }
		  
			function parsePosition(addr,item,idx) {
                //查地址
				var geocoder = new google.maps.Geocoder();
				$("#msg").append(addr +" ");
                geocoder.geocode({ 'address': addr }, function (results, status) {
					if (status === google.maps.GeocoderStatus.OK) {
                        // 如果有資料就會回傳
                        if (results) {
							ct=0;//次數歸0
							var loc = results[0].geometry.location;
							item.val( " "+loc.lat()+","+loc.lng());
							//ajax update--
							SetInfo(loc.lat(),loc.lng(),idx);
							$("#msg").append(" > "+loc.lat()+","+loc.lng()+" "+"<br>");				
                        }else{
							item.val( "-1,-1");
							$("#msg").append(" > -1,-1 "+"<br>");
						}												
                    }else{
					SetInfo('0','0',idx);
					item.val( "0,0");
					ct++;
					$("#msg").append(" > 0,0 "+"<br>");
					} 					
                });
			}		  
					 //5Sec 自動啟動?
		 setTimeout(addr2latlng, 5000);
		 $("#msg").append('start run!!<br>');
	});
</script>
<div id="msg"></div>    
<table id="JSON_table"></table>
</body>
</html>